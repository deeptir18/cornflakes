### Experiment runner yaml for KV-server benchmark

time: 15
programs:
    start_server:
        start: sudo env LD_LIBRARY_PATH={cornflakes_dir}/cornflakes-libos/3rdparty/dpdk/install/lib/x86_64-linux-gnu nice -n -19 taskset -c 1 {cornflakes_dir}/target/release/kv --config_file {config_file} --mode server --trace {trace} --debug_level info --size {size} --num_values {num_values} --serialization {library}
        hosts: [server]
        perf: sudo perf stat -e task-clock,cycles,instructions,cache-references,cache-misses,L1-dcache-loads,L1-dcache-load-misses,L1-dcache-stores,dTLB-loads,dTLB-load-misses,dTLB-prefetch-misses,LLC-loads,LLC-load-misses,LLC-stores,LLC-store-misses -o {folder}/server.perf.log
        log:
            out: "{folder}/server.log"
            err: "{folder}/server.err.log"
            record: "{folder}/server.record.log"
        stop: sudo kill -SIGINT `ps aux | grep {cornflakes_dir}/target/release/kv | grep -v grep | awk '{{print $2}}'`

    start_client:
        start: sudo env LD_LIBRARY_PATH={cornflakes_dir}/cornflakes-libos/3rdparty/dpdk/install/lib/x86_64-linux-gnu {cornflakes_dir}/target/release/kv --config_file {config_file} --mode client --queries {queries} --debug_level info --size {size} --rate {rate} --serialization {client-library} --server_ip {server_ip} --time {time} --num_values {num_values} --start_cutoff {start_cutoff} --num_threads {num_threads} --num_clients {num_machines} --client_id {machine_id} --logfile {folder}/{host}.latency.log --threadlog {folder}/{host}.threads.log
        hosts: [client1, client2, client3]
        log:
            out: "{folder}/{host}.log"
            err: "{folder}/{host}.err.log"
            record: "{folder}/{host}.record.log"

commands:
    - program: start_server
      begin: 0

    - program: start_client
      begin: 7
            
            
